<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    <title>Network protocol learning | IP </title>
    <meta name="description" content>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/network-protocol-learn/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/network-protocol-learn/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"title":"IP","path":"ip.html"},"data":{"navigation":{"logo":{"text":"Network Protocol Learn","type":"link","path":"index.html"},"main":[{"text":"IP","type":"link","path":"ip.html"},{"text":"物理层和链路层","type":"link","path":"physical_link.html"},{"text":"ICMP","type":"link","path":"icmp.html"},{"text":"网关","type":"link","path":"gateway.html"},{"text":"UDP","type":"link","path":"udp.html"},{"text":"TCP","type":"link","path":"tcp.html"},{"text":"HTTP","type":"link","path":"http.html"},{"text":"HTTPS","type":"link","path":"https.html"},{"text":"流媒体协议","type":"link","path":"stream.html"},{"text":"P2P 协议","type":"link","path":"p2p.html"},{"text":"DNS","type":"link","path":"dns.html"},{"text":"CDN","type":"link","path":"cdn.html"},{"text":"数据中心","type":"link","path":"data_center.html"},{"text":"VPN","type":"link","path":"vpn.html"},{"text":"移动网络","type":"link","path":"nemo.html"},{"text":"云中网络","type":"link","path":"cloud.html"},{"text":"容器网络","type":"link","path":"container.html"},{"text":"RPC","type":"link","path":"rpc.html"},{"text":"网络工具","type":"label"},{"text":"网络工具","type":"link","path":"net_tools.html"},{"text":"WireShark","type":"link","path":"wireshark.html"},{"text":"THEME","type":"label"},{"text":"使用文档主题","type":"link","path":"theme/theme-usage.html"},{"text":"SUPPORT AND FEEDBACK","type":"label"},{"text":"Raise an Issue on Github","type":"link","path":"https://github.com/shipengqi/network-protocol-learn/issues/new"}]}},"config":{"timezone":"UTC","root":"/network-protocol-learn/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot><nav class="doc-navbar"><a href="/network-protocol-learn/index.html" class="doc-navbar__logo"><img src="/network-protocol-learn/images/logo.png" class="doc-navbar__logo__img"><span class="doc-navbar__logo__text">Network Protocol Learn</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <h1 id="IP"><a href="#IP" class="headerlink" title="IP"></a>IP</h1><p><strong>IP 地址是一个网卡在网络世界的通讯地址，相当于现实世界的门牌号码</strong>。</p>
<h2 id="怎么查看-IP-地址"><a href="#怎么查看-IP-地址" class="headerlink" title="怎么查看 IP 地址"></a>怎么查看 IP 地址</h2><p>Windows 上是 <code>ipconfig</code>， 在Linux 上是 <code>ifconfig</code>，<code>ip addr</code>。</p>
<p>一台机器包含一个或多个网卡，大部分的网卡都会有一个 IP 地址（不是必须的）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_0_17_centos ~]<span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:7d:a2:a5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.16.0.17/20 brd 172.16.15.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>运行 <code>ip addr</code> 显示了机器的所有网卡。上面的输出，IP 地址的后面有个 <code>scope</code>，对于 <code>eth0</code> 这张网卡来讲，是 <code>global</code>，说明这张网卡是<br>可以对外的，可以接收来自各个地方的包。</p>
<p>对于 <code>lo</code> 来讲，是 <code>host</code>，说明这张网卡仅仅可以供本机相互通信。<code>lo</code> 全称是 <code>loopback</code>，又称环回接口，往往会被分配到 <code>127.0.0.1</code> 这<br>个地址。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。这就是为什么你可以在浏览器通过访问 <code>127.0.0.1</code> 这个地址来<br>访问本地服务，而且一般在你本机的 <code>host</code> 文件，会有 <code>127.0.0.1 localhost</code>，这是个映射关系，访问 <code>localhost</code> 相当于 <code>127.0.0.1</code>。</p>
<h3 id="MAC-地址"><a href="#MAC-地址" class="headerlink" title="MAC 地址"></a>MAC 地址</h3><p><code>link/ether 52:54:00:7d:a2:a5 brd ff:ff:ff:ff:ff:ff</code>，这个是 <strong>MAC 地址</strong>，网卡的物理地址，十六进制，6 个 byte 表示。</p>
<p>MAC 地址是唯一的，不会有两个网卡有相同的 MAC 地址，那么为什么不直接用 MAC 地址来进行通信？</p>
<p><strong>一个网络包要从一个地方传到另一个地方，除了要有确定的地址，还需要有定位功能</strong>。IP 地址，就是用来定位的。</p>
<p><strong>MAC 地址更像是身份证，是一个唯一的标识。它的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不用担心冲突</strong>。<br>从硬件角度，保证不同的网卡有不同的标识。</p>
<p>例如，你去杭州市网商路 599 号B 楼6 层找刘超，你在路上问路，可能被问的人不知道 B 楼是哪个，但是可以给你指网商路怎么去。但是如果你问一<br>个人，你知道这个身份证号的人在哪里吗？可想而知，没有人知道。</p>
<p>MAC 地址是有一定定位功能的，只不过范围非常有限。你可以根据 IP 地址，找到杭州市网商路 599 号 B 楼6 层，但是依然找不到我，你就可以靠吼了，<br>大声喊身份证 XXXX 的是哪位？我听到了，我就会站起来说，是我啊。</p>
<p>MAC 地址的通信范围比较小，局限在一个子网里面。例如，例如，从 <code>192.168.0.2/24</code> 访问 <code>192.168.0.3/24</code> 是可以用 MAC 地址的。一旦跨<br>子网，即从 <code>192.168.0.2/24</code> 到 <code>192.168.1.2/24</code>，MAC 地址就不行了，需要 IP 地址起作用了。</p>
<h3 id="网络设备的状态标识"><a href="#网络设备的状态标识" class="headerlink" title="网络设备的状态标识"></a>网络设备的状态标识</h3><p><code>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</code> 是干什么的？这个叫作 <code>net_device flags</code>，<strong>网络设备的状态标识</strong>。</p>
<ul>
<li><code>UP</code> 表示网卡处于启动的状态</li>
<li><code>BROADCAST</code> 表示这个网卡有广播地址，可以发送广播包</li>
<li><code>MULTICAST</code> 表示网卡可以发送多播包</li>
<li><code>LOWER_UP</code> 表示<code>L1</code>是启动的，也即网线插着呢。</li>
<li><code>MTU1500</code> 是指最大传输单元 MTU 为 1500，这是以太网的默认值。MTU 是二层MAC 层的概念。MAC 层有 MAC 的头，以太网规定连 MAC 头带<br>正文合起来，不允许超过 1500 个字节。正文里面有 IP 的头、TCP 的头、HTTP 的头。如果放不下，就需要分片来传输。</li>
</ul>
<h2 id="CIDR"><a href="#CIDR" class="headerlink" title="CIDR"></a>CIDR</h2><p>32 位的 IP 地址就被分成了 5 类：</p>
<p><img src="images/ip/ipaddr.jpg" alt></p>
<p>C 类地址能包含的最大主机数量只有 254 个（C 类地址只有后面 8 位表示主机号，最大数字为 255，<code>x.x.x.255</code> 是广播地址），现在估计一个网吧<br>都不够用。<br>B 类地址能包含的最大主机数量（65534 个）又太多了。6 万多台机器放在一个网络下面，一般的企业基本达不到这个规模，闲着的地址就是浪费。</p>
<p>CIDR 就是为了解决上面的问题。</p>
<p>五类地址中，D 类是<strong>组播地址</strong>。使用这一类地址，属于某个组的机器都能收到。这有点类似在公司里面大家都加入了一个邮件组。发送邮件，<br>加入这个组的都能收到。</p>
<h3 id="无类型域间选路（CIDR）"><a href="#无类型域间选路（CIDR）" class="headerlink" title="无类型域间选路（CIDR）"></a>无类型域间选路（CIDR）</h3><p>CIDR，打破了原来设计的几类地址的做法，将 32 位的 IP 地址一分为二，前面是网络号，后面是主机号。上面例子中的 IP 地址：<code>172.16.0.17/20</code>，<br>这个 IP 地址中有一个斜杠，斜杠后面有个数字 20。这种地址表示形式，就是 CIDR。后面 20 的意思是，32 位中，前 20 位是网络号，后 12 位<br>是主机号。</p>
<p>伴随着 CIDR 存在的，一个是<strong>广播地址</strong>，<code>172.16.0.255</code>。如果发送这个地址，所有 <code>172.16.0</code> 网络里面的机器都可以收到。另一个<br>是<strong>子网掩码</strong>，<code>255.255.255.0</code>。将子网掩码和IP 地址进行 <code>AND</code> 计算，就可得到<strong>网络号</strong>。</p>
<h3 id="公有-IP-地址和私有-IP-地址"><a href="#公有-IP-地址和私有-IP-地址" class="headerlink" title="公有 IP 地址和私有 IP 地址"></a>公有 IP 地址和私有 IP 地址</h3><p>在日常的工作中，几乎不用划分 A 类、B 类或者 C 类，所以时间长了，很多人就忘记了这个分类，而只记得 CIDR。但是有一点还是要注意的，<br>就是<strong>公有 IP 地址</strong>和<strong>私有 IP 地址</strong>。</p>
<p><img src="images/ip/ipaddr-range.jpg" alt></p>
<p>表格最右列是私有 IP 地址段。平时我们看到的数据中心里，办公室、家里或学校的 IP 地址，一般都是私有 IP 地址段。因为这些地址允许组织内<br>部的 IT 人员自己管理、自己分配，而且可以重复。</p>
<p>这就像每个小区有自己的楼编号和门牌号，你们小区可以叫 6 栋，我们小区也叫 6 栋，没有任何问题。但是一旦出了小区，就需要使用公有 IP 地址。</p>
<p><code>192.168.0.x</code> 是最常用的私有 IP 地址。一般你家里地上网设备不会超过 254 个，所以 <code>/24</code> 基本就够了。那么 <code>192.168.0</code> 就是网络号，<br>整个网络里面的第一个地址 <code>192.168.0.1</code>，一般都是<strong>网关地址</strong>，比如你家的路由器。<code>192.168.0.255</code> 就是<strong>广播地址</strong>。一旦发送这个<br>地址，整个 <code>192.168.0</code> 网络里面的所有机器都能收到。</p>
<h3 id="一个容易“犯错”的-CIDR"><a href="#一个容易“犯错”的-CIDR" class="headerlink" title="一个容易“犯错”的 CIDR"></a>一个容易“犯错”的 CIDR</h3><p><code>16.158.165.91/22</code> 这个 CIDR。求一下这个网络的第一个地址、子网掩码和广播地址。</p>
<p>要是上来就写 <code>16.158.165.1</code>，那就大错特错了。</p>
<p><code>/22</code> 不是 8 的整数倍，不好办，只能先变成二进制来看。<code>16.158</code> 的部分不会动，它占了前 16 位。中间的 165，变为二进制为 <code>10100101</code>。<br>除了前面的 16 位，还剩 6 位。所以，这 8 位中前 6 位是网络号，<code>16.158.&lt;101001&gt;</code>，而 <code>&lt;01&gt;.91</code> 是机器号。第一个地址<br>是 <code>16.158.&lt;101001&gt;&lt;00&gt;.1</code>，即 <code>16.158.164.1</code>。<br>子网掩码是 <code>255.255.&lt;111111&gt;&lt;00&gt;.0</code>，即 <code>255.255.252.0</code>。广播地址为 <code>16.158.&lt;101001&gt;&lt;11&gt;.255</code>，即 <code>16.158.167.255</code>。</p>
<h2 id="DHCP：IP-是怎么来的，又是怎么没的？"><a href="#DHCP：IP-是怎么来的，又是怎么没的？" class="headerlink" title="DHCP：IP 是怎么来的，又是怎么没的？"></a>DHCP：IP 是怎么来的，又是怎么没的？</h2><h3 id="如何配置-IP-地址"><a href="#如何配置-IP-地址" class="headerlink" title="如何配置 IP 地址"></a>如何配置 IP 地址</h3><p>命令行自己配置一个地址。可以使用 <code>ifconfig</code>，也可以使用 <code>ip addr</code>。设置好了以后，用这两个命令，将网卡 up 一下，就可以开始工作了。</p>
<p>但是不能随便配置，例如 <code>192.168.1.6</code> 就在你这台机器的旁边，甚至是在同一个交换机上，而你把机器的地址设为了 <code>16.158.23.6</code>。在这台<br>机器上，你企图去 <code>ping 192.168.1.6</code>，你看着它有自己的源 IP 地址 <code>16.158.23.6</code>，也有目标 IP 地址 <code>192.168.1.6</code>，但是包发不出去，<br>这是因为 MAC 层还没填。<strong>IP 只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址</strong>。如果不是，<strong>它便不会直接将包发送到网络上，而是<br>企图将包发送到网关</strong>。</p>
<p>如果你配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去。对于 <code>192.168.1.6</code> 这台机器来讲，虽然路过它家门的这个包，<br>目标 IP 是它，但是无奈 MAC 地址不是它的，所以它的网卡是不会把包收进去的。如果没有配置网关，那包压根就发不出去。</p>
<p><strong>网关要和当前的网络至少一个网卡是同一个网段的</strong>，否则不会配置成功。</p>
<h3 id="动态主机配置协议（DHCP）"><a href="#动态主机配置协议（DHCP）" class="headerlink" title="动态主机配置协议（DHCP）"></a>动态主机配置协议（DHCP）</h3><p>有了 DHCP 协议，网络管理员只需要配置一段共享的 IP 地址。每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配<br>置好就可以了。等人走了，或者用完了，还回去，这样其他的机器也能用。</p>
<p><strong>如果是数据中心里面的服务器，IP 一旦配置好，基本不会变，这就相当于买房自己装修。 DHCP 的方式就相当于租房。你不用装修，都是帮你配<br>置好的。你暂时用一下，用完退租就可以了。</strong></p>
<h3 id="DHCP-的工作方式"><a href="#DHCP-的工作方式" class="headerlink" title="DHCP 的工作方式"></a>DHCP 的工作方式</h3><p>一台机器新加入一个网络的时候，只知道自己的 MAC 地址。怎么办？先吼一句，我来啦，有人吗？这时候的沟通基本靠“吼”。这一步，<br>称为<strong>DHCP Discover</strong>。</p>
<p>第一步：<br>新来的机器使用 IP 地址 <code>0.0.0.0</code> 发送了一个广播包，目的 IP 地址为 <code>255.255.255.255</code>。<br><img src="images/ip/dhcp1.jpg" alt></p>
<p>第二步：<br><strong>DHCP Server</strong> 立刻能知道来了一个“新人”，这个时候，我们可以体会 MAC 地址唯一的重要性了。当一台机器带着自己的 MAC 地址加入一个网络<br>的时候，MAC 是它唯一的身份，如果连这个都重复了，就没办法配置了。<strong>只有 MAC 唯一，IP 管理员才能知道这是一个新人</strong>。租给它一个 IP 地址，<br>这个过程我们称为 <strong>DHCP Offer</strong>。同时，DHCP Server 为此客户<strong>保留为它提供的 IP 地址</strong>，从而不会为其他 DHCP 客户分配此 IP 地址。<br><strong>DHCP Offer 里面有新的分配的地址</strong>：<br><img src="images/ip/dhcp2.jpg" alt></p>
<p>DHCP Server 仍然使用广播地址作为目的地址，因为，此时请求分配 IP 的新人还没有自己的 IP。</p>
<p>第三步：<br>如果有多个 DHCP Server，这台新机器会收到多个 IP 地址，选择其中一个 DHCP Offer，<strong>一般是最先到达的那个</strong>。并且会向网络发送一<br>个 DHCP Request 广播数据包，包中包含客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址等，并告诉所<br>有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。<br><img src="images/ip/dhcp3.jpg" alt></p>
<p>由于还没有得到 DHCP Server 的最后确认，客户端仍然使用 <code>0.0.0.0</code> 为源 IP 地址、<code>255.255.255.255</code> 为目标地址进行广播。</p>
<p>第四步：<br>DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址<br>的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。</p>
<p><img src="images/ip/dhcp4.jpg" alt></p>
<h3 id="IP-地址的收回和续租"><a href="#IP-地址的收回和续租" class="headerlink" title="IP 地址的收回和续租"></a>IP 地址的收回和续租</h3><p>客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应<br>的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。</p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/network-protocol-learn/script/doc.js"></script>

    

  </body>
</html>
